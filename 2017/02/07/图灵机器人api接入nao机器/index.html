<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>将图灵机器人api接入nao机器人 | Eric's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">将图灵机器人api接入nao机器人</h1><a id="logo" href="/.">Eric's Blog</a><p class="description">写字的地方</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">将图灵机器人api接入nao机器人</h1><div class="post-meta">Feb 7, 2017<span> | </span><span class="category"><a href="/categories/Python/">Python</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>用nao自带的<code>choregraphe</code>新建项目，结构如下图所示：<br><img src="http://p1.bpimg.com/584930/c7e35784edfe1819.png" alt="enter image description here"><br>简单来说，一共分为4步</p>
<ol>
<li>启动nao自带的录音程序，拍打nao头部启动录音，并输出录音文件所在的路径。</li>
<li>因图灵机器人暂时只支持纯文本输入，需要将录音转换成文字。</li>
<li>将转换出来的文字调用图灵机器人api，输出回答。</li>
<li>根据不同回答配合不同肢体动作。</li>
</ol>
<p>###设置nao录音程序<br>启动<code>choregraphe</code>，在左下指令盒库搜索<code>Record Sound</code>,如下图：<br><img src="http://p1.bpimg.com/584930/4cf86ab9c6550405.png" alt="enter image description here"><br><code>输入</code>和<code>输出</code>均有4种基本类型：<code>动态</code>，<code>激活</code>，<code>数字</code>，<code>字符串</code><br>具体类型区别详见官方文档。<br>单击进入<code>Record Sound</code>修改<code>Rec. Sound File</code>如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">import time</div><div class="line"></div><div class="line">class MyClass(GeneratedClass):</div><div class="line">    def __init__(self):</div><div class="line">        GeneratedClass.__init__(self, False)</div><div class="line">        try:</div><div class="line">            self.ad = ALProxy(&quot;ALAudioDevice&quot;)</div><div class="line">        except Exception as e:</div><div class="line">            self.ad = None</div><div class="line">            self.logger.error(e)</div><div class="line">        self.leds = ALProxy(&quot;ALLeds&quot;)</div><div class="line">        self.player = ALProxy(&apos;ALAudioPlayer&apos;)</div><div class="line">        self.filepath = &quot;&quot;</div><div class="line"></div><div class="line">    def onLoad(self):</div><div class="line">        self.bIsRecording = False</div><div class="line">        self.bIsRunning = False</div><div class="line"></div><div class="line">    def onUnload(self):</div><div class="line">        self.bIsRunning = False</div><div class="line">        #用ftp把音频上传到&apos;/home/nao/recordings/ringstones/&apos;目录</div><div class="line">        if( self.bIsRecording ):</div><div class="line">            self.player.post.playFileFromPosition(&apos;/home/nao/recordings/ringstones/drip.wav&apos;, 0.00, 1.00, 0.00)</div><div class="line">            self.ad.stopMicrophonesRecording()</div><div class="line">            self.bIsRecording = False</div><div class="line"></div><div class="line">    def onInput_onStart(self, p):</div><div class="line">        if(self.bIsRunning):</div><div class="line">            return</div><div class="line">        self.bIsRunning = True</div><div class="line">        sGroup = &quot;FaceLeds&quot;</div><div class="line">        RGB = [0, 255, 51]</div><div class="line">        sExtension = self.toExtension( self.getParameter(&quot;Microphones used&quot;) )</div><div class="line">        self.filepath = p + sExtension</div><div class="line">        if self.ad:</div><div class="line">            self.leds.fadeRGB(sGroup, 256*256*RGB[0] + 256*RGB[1] + RGB[2], 0.5)</div><div class="line">            time.sleep(0.2)</div><div class="line">            self.ad.startMicrophonesRecording( self.filepath )</div><div class="line">            self.bIsRecording = True</div><div class="line">        else:</div><div class="line">            self.logger.warning(&quot;No sound recorded&quot;)</div><div class="line"></div><div class="line">    def onInput_onStop(self):</div><div class="line">        if( self.bIsRunning ):</div><div class="line">            self.onUnload()</div><div class="line">            self.onStopped(self.filepath)</div><div class="line"></div><div class="line">    def toExtension(self, sMicrophones):</div><div class="line">        if( sMicrophones == &quot;Front head microphone only (.ogg)&quot; ):</div><div class="line">            return &quot;.ogg&quot;</div><div class="line">        else:</div><div class="line">            return &quot;.wav&quot;</div></pre></td></tr></table></figure></p>
<p>主要增加了<code>录音开始</code>以及nao机器人<code>眼睛灯</code>的提示。最后输出录音文件所在的位置。</p>
<p>###对录音文件的处理<br>直接看代码吧<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line">import urllib2</div><div class="line">import json</div><div class="line">import base64</div><div class="line">import httplib</div><div class="line"></div><div class="line">class MyClass(GeneratedClass):</div><div class="line">    def __init__(self):</div><div class="line">        GeneratedClass.__init__(self)</div><div class="line"></div><div class="line">    def onLoad(self):</div><div class="line">        #put initialization code here</div><div class="line">        pass</div><div class="line"></div><div class="line">    def onUnload(self):</div><div class="line">        #put clean-up code here</div><div class="line">        pass</div><div class="line"></div><div class="line">#下面的p就是录音文件所在的位置</div><div class="line">    def onInput_onStart(self, p):</div><div class="line">        #self.onStopped() #activate the output of the box</div><div class="line">        accessToken = self.getAccessToken()</div><div class="line">        speech_file = str(p)</div><div class="line">        self.logger.info(p)</div><div class="line">        try:</div><div class="line">            cmd = self.baidu_asr(speech_file, accessToken)</div><div class="line">            self.logger.info(cmd)</div><div class="line">        except Exception, e:</div><div class="line">            cmd = &apos;&apos;</div><div class="line">        self.logger.info(cmd)</div><div class="line">        res = self.request_tuling(cmd)</div><div class="line">        self.logger.info(res)</div><div class="line"></div><div class="line">        try:</div><div class="line">            response_dic = json.loads(res, encoding=&apos;utf-8&apos;)</div><div class="line">            answer = response_dic[&apos;text&apos;].encode(&apos;utf-8&apos;, &apos;ignore&apos;)</div><div class="line">        except Exception,e:</div><div class="line">            self.logger.error(e)</div><div class="line">            answer = &apos;对不起,没能听清你的话呢&apos;</div><div class="line"></div><div class="line">        try:</div><div class="line">            response_dic = json.loads(res, encoding=&apos;utf-8&apos;)</div><div class="line">            special_value1 = response_dic[&apos;special_value1&apos;]</div><div class="line">        except Exception,e:</div><div class="line">            self.logger.error(e)</div><div class="line">            special_value1 = &apos;0&apos;</div><div class="line"></div><div class="line">        try:</div><div class="line">            response_dic = json.loads(res, encoding=&apos;utf-8&apos;)</div><div class="line">            special_value2 = response_dic[&apos;special_value2&apos;].encode(&apos;utf-8&apos;, &apos;ignore&apos;)</div><div class="line">        except Exception,e:</div><div class="line">            self.logger.error(e)</div><div class="line">            special_value2 = &apos;&apos;</div><div class="line"></div><div class="line">        self.output([answer, special_value1, special_value2])</div><div class="line"></div><div class="line"></div><div class="line">    def onInput_onStop(self):</div><div class="line">        self.onUnload() #it is recommended to reuse the clean-up as the box is stopped</div><div class="line">        self.onStopped() #activate the output of the box</div><div class="line"></div><div class="line">    def getAccessToken(self):</div><div class="line">        ApiKey = &apos;your_baidu_speech_apikey&apos;</div><div class="line">        SecretKey = &apos;your_secret_key&apos;</div><div class="line">        auth_url = &quot;https://openapi.baidu.com/oauth/2.0/token?grant_type=client_credentials&amp;client_id=&quot; +   ApiKey + &quot;&amp;client_secret=&quot; + SecretKey</div><div class="line">        res = urllib2.urlopen(auth_url)</div><div class="line">        json_data = res.read()</div><div class="line">        return json.loads(json_data)[&apos;access_token&apos;]</div><div class="line"></div><div class="line">#请求百度语音识别接口，输入音频文件路径，输出语音识别出来的文本</div><div class="line">    def baidu_asr(self, speech_file, access_token):</div><div class="line">        asr_server = &apos;http://vop.baidu.com/server_api&apos;</div><div class="line">        with open(speech_file, &apos;rb&apos;) as f:</div><div class="line">            speech_data = f.read()</div><div class="line">            speech_base64=base64.b64encode(speech_data).decode(&apos;utf-8&apos;)</div><div class="line">            speech_length=len(speech_data)</div><div class="line">            data_dict = &#123;&apos;format&apos;:&apos;wav&apos;, &apos;rate&apos;:16000, &apos;channel&apos;:1, &apos;cuid&apos;:&apos;005056c00008&apos;,   &apos;token&apos;:access_token, &apos;lan&apos;:&apos;zh&apos;, &apos;speech&apos;:speech_base64, &apos;len&apos;:speech_length&#125;</div><div class="line">            json_data = json.dumps(data_dict)</div><div class="line">            json_length = len(json_data)</div><div class="line">            request = urllib2.Request(url=asr_server)</div><div class="line">            request.add_header(&quot;Content-Type&quot;, &quot;application/json&quot;)</div><div class="line">            request.add_header(&quot;Content-Length&quot;, json_length)</div><div class="line">            fs = urllib2.urlopen(url=request, data=json_data)</div><div class="line">            result_str = fs.read()</div><div class="line">            json_resp = json.loads(result_str, encoding=&apos;utf-8&apos;)</div><div class="line">        self.logger.info(&apos;result_str &apos; + result_str)</div><div class="line">        return json_resp[&apos;result&apos;][0].encode(&apos;utf-8&apos;, &apos;ignore&apos;)</div><div class="line"></div><div class="line">#请求图灵接口</div><div class="line">    def request_tuling(self, cmd):</div><div class="line">        if not cmd:</div><div class="line">            return &apos;&apos;</div><div class="line">        requrl = &apos;/openapi/api?key=your_tuling_apikey&amp;info=%s&apos; % cmd</div><div class="line">        try:</div><div class="line">            conn = httplib.HTTPConnection(&quot;www.tuling123.com&quot;, timeout=5)</div><div class="line">            conn.request(method=&quot;GET&quot;, url=requrl)</div><div class="line">            response = conn.getresponse()</div><div class="line">            res = response.read()</div><div class="line">            conn.close()</div><div class="line">        except Exception,e:</div><div class="line">            self.logger.error(e)</div><div class="line">            res = &apos;&apos;</div><div class="line">        return res</div></pre></td></tr></table></figure></p>
<p>主要分为两步：</p>
<ol>
<li>请求百度语音识别接口获取识别后的文字</li>
<li>将识别后的文字请求图灵接口，获取机器人回答<blockquote>
<p>以上代码包含对运动控制逻辑的处理，涉及隐私，故略去<br>###根据不同回答不同处理<br>此处主要包含对运动指令（前后左右，跳舞）以及普通对话处理<br>简单来说包含运动指令关键词的执行运动控制的指令盒，即上面的<code>controlBox</code>，纯文本对话的执行<code>SayWithBehavior</code>指令盒，控制逻辑主要由<code>decision</code>控制。<br>涉及运动控制的涉及隐私故略去。下面主要说纯文本输出部分。即<code>SayWithBehavior</code>指令盒<br>结构如下图：<br><img src="http://p1.bpimg.com/584930/19341807fabeeed5.png" alt="enter image description here"><br>随机动作指令盒包含不同时长的动作信息，具体可以看nao的官方文档中时间轴部分的介绍。<br>最后回复初始状态（<code>站立</code>）</p>
</blockquote>
</li>
</ol>
<p>###遗留问题</p>
<ol>
<li>每次需要拍打头部才能启动，没研究懂怎么根据声音强度，检测到说话自动调起录音程序</li>
<li>录音结束时间目前写死了。</li>
<li>反应比较慢，包括nao录音，语音识别过程，中间有失败没有迅速反馈，实际中会造成用户反复拍打进行识别。</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/02/07/图灵机器人api接入nao机器/" data-id="ciywaxi9y000d00ub2nsfsk3p" class="article-share-link">Aktie</a><div class="tags"><a href="/tags/python-nao/">python,nao</a></div><div class="post-nav"><a href="/2015/08/29/利用requests模块模拟登录百度并请求百小度/" class="next">利用requests模块模拟登录百度并请求百小度</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Machine-Learning/">Machine Learning</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python-机器学习/">Python,机器学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/python-编程语言/" style="font-size: 15px;">python,编程语言</a> <a href="/tags/Python-Machine-Learning/" style="font-size: 15px;">Python,Machine Learning</a> <a href="/tags/python-机器学习/" style="font-size: 15px;">python,机器学习</a> <a href="/tags/python-Scrapy/" style="font-size: 15px;">python,Scrapy</a> <a href="/tags/python-requests/" style="font-size: 15px;">python,requests</a> <a href="/tags/python-nao/" style="font-size: 15px;">python,nao</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/02/07/图灵机器人api接入nao机器/">将图灵机器人api接入nao机器人</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/29/利用requests模块模拟登录百度并请求百小度/">利用requests模块模拟登录百度并请求百小度</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/11/利用Scrapy下载WallHeaven的图片/">利用Scrapy下载WallHeaven的图片</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/29/naive-bayes-classifier-scratch-python/">机器学习之用Python从零实现贝叶斯分类器</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/20/Building-machine-learning-system/">Building machine learning system</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/20/About-python-decorator/">关于python装饰器</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Eric's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>